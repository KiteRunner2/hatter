<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"> -->

    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    
    <link rel="stylesheet" href="./css/style.css">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous">
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js'></script>

    <title>Hatter - Home</title>
    <script>
        function logOut() {
            localStorage.clear();
            location.href = '/login.html';
        }

        // window.onload = function() {
        //     // if(!localStorage.getItem("userId")){
        //     //     location.href = '/login.html';
        //     // }
        //     location.href = '/index.html';
        // };
        window.onload = function () {
            // !localStorage.key('userID') ? location.href = '/index.html' : false;
        };  

       
    </script>
</head>

<body>
    <div id="loginHeader">
        <div class="login">
            <div class="login-header">
                <h2>Login to Hatter</h2>
            </div>
            <form>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" class="form-control" id="loginEmail" placeholder="Enter email">
                </div>
                <div class="form-group">
                  <label for="loginPassword">Password</label>
                  <input type="password" class="form-control" id="loginPassword" placeholder="Enter Password">
                </div>
                <button id='loginBtn' type="submit" class="btn btn-primary">Login</button>
            </form>
            <div class="login-footer">
                <h2>Don't have a Hatter account?</h2>
                <!-- <button id="signupBtn" type="submit" class="btn btn-secondary">Sign Up</button> -->
                <a href="signup.html" class="btn btn-secondary" role="button">Sign Up</a>
            </div>
        </div>
        <div class="inlineForm">
            <div class="row row-login">
                <div class="col-8">
                    <form>
                        <div class="login-title">
                            <h2>Login to Hatter</h2>
                        </div>
                        <div class="row">
                            <div class="col-5">
                                <input type="email" class="form-control" id="loginEmail" placeholder="email">
                            </div>
                            <div class="col-5">
                                <input type="password" class="form-control" id="loginPassword" placeholder="password">
                            </div>
                            <div class="col-2">
                                <button id='loginBtn' type="submit" class="btn btn-primary">Login</button>
                            </div> 
                        </div>
                    </form>
                </div>
                <div class="signupContainer col-4">
                    <h2>Don't have a Hatter account?</h2>
                <!-- <button id="signupBtn" type="submit" class="btn btn-secondary">Sign Up</button> -->
                    <a href="signup.html" class="btn btn-secondary" role="button">Sign Up</a>
                </div>
            </div>

        </div>
    </div>
    
    <nav class="navbar sticky-top navbar-dark bg-dark">
        <a class="navbar-brand h1" href="#">
            <img src="./assets/Lightning.svg" width="30" height="30" class="d-inline-block align-top" alt="">
            Hatter
        </a>
        <form class="form-inline my-2 my-lg-0">
            <input id="searchBar" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-primary my-2 my-sm-0" type="submit">Search</button>
        </form>
    </nav>
    
    <div class="container-fluid">
        <div class="row row-main">
          <div class="section-profile col-lg-3 col-md-4">
            <div class="wrapper-profile">
                <div class="profilePicContainer">
                    <div class="profilePic" id="profilePic">
                     </div>
                </div>
                <div class="username">
                    <h2>dreamTeam</h2>
                </div>
                <div class="row metrics">
                    <div class="metrics-following col-lg-4 col-md-12">
                        <div class="followingMetric">Following</div>
                        <div id="followingNum" class="followingMetric">250</div>
                    </div>
                    <div class="metrics-followers col-lg-4 col-md-12">
                        <div class="followingMetric">Followers</div>
                        <div id="followersNum" class="followingMetric">100</div>
                    </div>
                    <div class="metrics-hattsSent col-lg-4 col-md-12">
                        <div class="followingMetric">Sent</div>
                        <div id="hattsSentNum"class="followingMetric">25</div>
                    </div>
            
                    
                </div>
                <div class="viewHatts">
                    <button id="viewHattsBtn" type="submit" class="btn btn-sm btn-secondary">View Hatts</button>
                </div>
                <div class="logout">
                    <button id="logoutBtn" type="submit" class="btn btn-sm btn-secondary">Logout</button>
                </div>
                <div class="createPost">
                    <button type="button" id="createPostBtn" data-toggle="modal" data-target="#postModal" class="btn btn-lg btn-primary">Create Post</button>
                </div>
            </div>
          </div>
          <!-- main cards -->
          <div class="section-feed col-lg-6 col-md-8">
            <div id="feedSectionWrapper" class="wrapper">
                <!-- container for hatt -->
                <div class="card card-post">
                    <div class="card-body">
                        <div class="row">
                            <!-- hatt starts picture -->
                            <div class="postPicContainer col-lg-2 col-sm-12">
                                <div class="postPic"></div>
                            </div>
                            <!-- pciture ends -->
                            <!-- hatt contents -->
                            <div class="cardContent col-lg-10 col-sm-12">
                                <div class="row">
                                    <div class="titleContainer">
                                        <h5 class="card-title">hatterUsername</h5>
                                        <h6 class="timeSince">10 m</h6>
                                    </div>
                                </div>
                                <div class="row row-content">
                                    <p class="card-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum.</p>
                                </div>
                                <div class="row row-metrics">
                                    <div class="commentsContainer">
                                        <a class="image" href="" data-toggle="modal" data-target="#commentModal" id="commentsIcon">
                                            <img src="./assets/Chat.svg" width="25" height="25" class="d-inline-block align-top" alt="comment-bubble">
                                        </a>
                                        <div class="counter">
                                            <h5 id="commentsNum">4</h5>
                                        </div>
                                    </div>
                                    <div class="hattsOffContainer">
                                        <a class="image" href="" id="hattsOffIcon">
                                            <img src="./assets/Heart-Empty.svg" width="25" height="25" class="d-inline-block align-top" alt="heart">
                                        </a>
                                        <div class="counter">
                                            <h5 id="hattsOffNum">25</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-post card-delete">
                    <div class="card-body">
                        <div class="row">
                            <div class="postPicContainer col-lg-2 col-sm-12">
                                <div class="postPic"></div>
                            </div>
                            <div class="cardContent col-lg-10 col-sm-12">
                                <div class="row">
                                    <div class="titleContainer">
                                        <h5 class="card-title">hatterUsername</h5>
                                        <h6 class="timeSince">10 m</h6>
                                    </div>
                                </div>
                                <div class="row row-content">
                                    <p class="card-text">DELETE THIS POST Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum.</p>
                                </div>
                                <div class="row row-metrics">
                                    <div class="commentsContainer">
                                        <a class="image" href="" data-toggle="modal" data-target="#commentModal" id="commentsIcon">
                                            <img src="./assets/Chat.svg" width="25" height="25" class="d-inline-block align-top" alt="comment-bubble">
                                        </a>
                                        <div class="counter">
                                            <h5 id="commentsNum">4</h5>
                                        </div>
                                    </div>
                                    <div class="hattsOffContainer">
                                        <a class="image" href="" id="hattsOffIcon">
                                            <img src="./assets/Heart-Empty.svg" width="25" height="25" class="d-inline-block align-top" alt="heart">
                                        </a>
                                        <div class="counter">
                                            <h5 id="hattsOffNum">25</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="row row-delete">
                                    <button id="deleteBtn" type="button" class="btn btn-outline-dark btn-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end of container for hatt -->

            </div>
          </div>

          <div class="section-follow col-lg-3 col-md-offset-4">
            <div id="followSection" class="wrapper">
                <!-- card follow starts -->
                <div class="card card-follow">
                    <div class="card-body">
                        <div class="row row-follow-main">
                            <div class="followPicContainer col-4">
                                <div class="followPic"></div>
                            </div>
                            <div class="col-8">
                                <h4 class="followAccount">followAccount</h4>
                                <button id="followBTn" type="submit" class="btn btn-sm btn-secondary">Follow</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- card follow end -->
            </div>
          </div>
        </div>

        <div id="postModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Create post</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <textarea class="form-control" rows="5" id="postForm"></textarea>
                </div>
                <div class="modal-footer">
                  <button type="button" id="postModalBtn" class="btn btn-primary" data-dismiss="modal">POST</button>
                </div>
              </div>
            </div>
        </div>

        <div id="commentModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Add comment</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <label id="commentTo" for="form-control">@hatterUser</label>
                  <textarea class="form-control" rows="5" id="postForm"></textarea>
                </div>
                <div class="modal-footer">
                  <button type="button" id="postModalBtn" class="btn btn-primary" data-dismiss="modal">POST</button>
                </div>
              </div>
            </div>
        </div>

      </div>
    <script>
        $('#postModal').on('shown.bs.modal', function () {
            $('#createPostBtn').trigger('focus')
        }) 

        $("#loginBtn").click(async function(event){
                event.preventDefault();
                const email = $('#loginEmail').val();
                const password = $('#loginPassword').val();

                const loginInfo = {
                    email: email,
                    password: password
                };

                const auth = await $.post("/api/auth", loginInfo);
                if(auth.response == 'OK') {
                    // alert("login successful")
                    $("#loginHeader").hide();
                    console.log(auth.user.id);
                    localStorage.setItem("userId", auth.user.id);
                    localStorage.setItem("username", auth.user.name);
                    localStorage.setItem("followers", auth.user.followers);
                    localStorage.setItem("following", auth.user.following);
                    localStorage.setItem("hatts", auth.user.hatts);
                    // window.location.href = '/index.html';
                    populateHatts();
                    populateFollowSection();
                    getProfilePic();
                    setFollowers();
                    setFollowing();
                    setHatts();
                } else {
                    alert(auth.response);
                }
            })
        
    
        //populating hatts section

        function setFollowers() {
            const followers = localStorage.getItem('followers');
            document.getElementById('followersNum').innerHTML = followers;
        }

        function setFollowing() {
            const following = localStorage.getItem('following');
            document.getElementById('followingNum').innerHTML = following;
        }
        function setHatts(){
            const hatts = localStorage.getItem('hatts');
            document.getElementById('hattsSentNum').innerHTML = hatts;
        }

        async function populateHatts(){
            let recentHatts = '';
            let commentsPerHatt = new Map();
            let content = ''
            $.get('/api/getRecentHatts')
                .then(response => {
                    recentHatts = response;
                    // console.log(recentHatts);
                    $.get('/api/getNoOfCommentsPerHatt')
                        .then(result => {
                            // console.log(result);
                            result.forEach(element => {
                                commentsPerHatt.set(element.hatt_id, element.num);
                            });
                            // console.log(recentHatts);
                            // console.log(commentsPerHatt.get(1));
                            recentHatts.forEach(element => {
                                // console.log(element.hatt_id);
                                // console.log(commentsPerHatt.get(element.hatt_id));
                                // let day = moment(element.tweet_time);
                                // console.log(moment(element.tweet_time).startOf('day').fromNow());
                                content += `<div data-userid="${element.user_id}" class="card card-post">
                    <div class="card-body">
                        <div class="row">
                            <!-- hatt starts picture -->
                            <div class="postPicContainer col-lg-2 col-sm-12">
                                <div class="postPic"></div>
                            </div>
                            <!-- pciture ends -->
                            <!-- hatt contents -->
                            <div class="cardContent col-lg-10 col-sm-12">
                                <div class="row">
                                    <div class="titleContainer">
                                        <h5 class="card-title">${element.name}</h5>
                                        <h6 class="timeSince">${moment(element.tweet_time).startOf('minute').fromNow()}</h6>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="card-text">
                                    <p>${element.text}</p>
                                    </div>
                                </div>
                                
                                <div class="row row-metrics">
                                    <div class="commentsContainer">
                                        <a class="image" href="" data-toggle="modal" data-target="#commentModal" id="commentsIcon">
                                            <img src="./assets/Chat.svg" width="25" height="25" class="d-inline-block align-top" alt="comment-bubble">
                                        </a>
                                        <div class="counter">
                                            <h5 id="commentsNum">${commentsPerHatt.get(element.id)?commentsPerHatt.get(element.id):0}</h5>
                                        </div>
                                    </div>
                                    <div class="hattsOffContainer">
                                        <a class="image" href="" id="hattsOffIcon">
                                            <img src="./assets/Heart-Empty.svg" width="25" height="25" class="d-inline-block align-top" alt="heart">
                                        </a>
                                        <div class="counter">
                                            <h5 id="hattsOffNum">25</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`
                            });
                            // console.log(content);
                            $('#feedSectionWrapper').html('');
                            $('#feedSectionWrapper').html(content);
                        })
                })

        }

        async function populateFollowSection(){
            $.get('/api/getTop5Followed')
            .then(result => {
                // console.log(result);
                let content = '';
                    result.forEach(element=>{
                    //     content += `<div class="card card-follow">
                    //     <div class="card-body">
                    //         <div class="row row-follow">
                    //             <div class="col-8">
                    //                 <h4 class="followAccount">${element.name}</h4>
                    //             </div>
                    //             <div class="col-4">
                    //                 <button id="followBTn" data-id="${element.user}" data-name="${element.name}" type="submit"
                    //                     class="btn btn-sm btn-secondary" onClick="follow(event);">Follow</button>
                    //             </div>
                    //         </div>
                    //     </div>
                    // </div>`

                    content += `<div class="card card-follow">
                    <div class="card-body">
                        <div class="row row-follow-main">
                            <div class="followPicContainer col-4">
                                <div class="followPic"></div>
                            </div>
                            <div class="col-8">
                                <label class="followAccount">${element.name}</label>
                                <button id="followBTn" data-id="${element.user}" data-name="${element.name}" type="submit" class="btn btn-sm btn-secondary" onClick="follow(event);">Follow</button>
                            </div>
                        </div>
                    </div>
                </div>`
                    })
                    $('#followSection').html('');
                    $('#followSection').html(content)

            })
            .catch(error => {
                console.log(error);
            })
        }

        async function getProfilePic() {
            const userId = localStorage.getItem('userId');
            console.log("u ", userId);
            const profileImage = await $.get(`/api/getProfilePic/${userId}`);
            console.log(profileImage);
                if(profileImage.response == 'OK') {
                    //alert("call successful")
                    //$("#profilePic").attr("src",profileImage.path); 
                    document.getElementById("profilePic").style.backgroundImage = 'url('+profileImage.path+')';
                    document.getElementById("profilePic").style.backgroundPosition = 'center';
                } else {
                    alert(profileImage.response);
                }
        }

        function follow(event){
            // console.log('btn follow clicked');
            // console.log(event.target.dataset.id);
            postData = {
                user:localStorage.getItem('userId'),
                follower:event.target.dataset.id
            }
            // console.log(postData);
            $.post('/api/addFollower',postData)
            .then(result => {
                alert(`You are now following ${event.target.dataset.name}`);
            })
            .catch(error=>{
                alert('Error! Please try again later!')
            })
        }
        async function renderUserHatts(){
            // let userId = localStorage.getItem('userId');
            let userId=1;
            let getData = {
                user_id:userId
            }
            // console.log(getData);
            let commentsPerHatt = new Map();
            let result = await $.get('/api/getNoOfCommentsPerHatt');
            result.forEach(element => {
                                commentsPerHatt.set(element.hatt_id, element.num);
            })
            console.log(commentsPerHatt);
            result = await $.post('/api/getUserHatts',getData);
            console.log(result);
            let content = '';
            result.forEach(element=>{
                content += `<div class="card card-post card-delete">
                    <div class="card-body">
                        <div class="row">
                            <div class="postPicContainer col-lg-2 col-sm-12">
                                <div class="postPic"></div>
                            </div>
                            <div class="cardContent col-lg-10 col-sm-12">
                                <div class="row">
                                    <div class="titleContainer">
                                        <h5 class="card-title">${element.name}</h5>
                                        <h6 class="timeSince">${moment(element.tweet_time).startOf('minute').fromNow()}</h6>
                                    </div>
                                </div>
                                <div class="row row-content">
                                    <p class="card-text">${element.text}</p>
                                </div>
                                <div class="row row-metrics">
                                    <div class="commentsContainer">
                                        <a class="image" href="" data-toggle="modal" data-target="#commentModal" id="commentsIcon">
                                            <img src="./assets/Chat.svg" width="25" height="25" class="d-inline-block align-top" alt="comment-bubble">
                                        </a>
                                        <div class="counter">
                                            <h5 id="commentsNum">${commentsPerHatt.get(element.id)?commentsPerHatt.get(element.id):0}</h5>
                                        </div>
                                    </div>
                                    <div class="hattsOffContainer">
                                        <a class="image" href="" id="hattsOffIcon">
                                            <img src="./assets/Heart-Empty.svg" width="25" height="25" class="d-inline-block align-top" alt="heart">
                                        </a>
                                        <div class="counter">
                                            <h5 id="hattsOffNum">25</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="row row-delete">
                                    <button onclick="deleteHatt(event)" data-hattId="${element.id}"  id="deleteBtn" type="button" class="btn btn-outline-dark btn-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            })
            // console.log(content);

        }
        async function deleteHatt(event){
            let hattid = event.target.dataset.hattId;
            let deleteData = {
                id:hattid
            }
            let result = await $.delete('/api/deleteHatt',deleteData);
            renderUserHatts();
        }


        // $(document).ready(function(){
        //     if (localStorage.key('userId')){
        //     $("#loginHeader").hide();
        //     populateHatts();
        //     populateFollowSection();
        //     getProfilePic();
        //     }
        // })
        renderUserHatts();
    </script>


</body>

</html>